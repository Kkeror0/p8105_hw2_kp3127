---
title: "p8105_hw2_kp3127"
output: html_document
date: "2025-09-25"
---

```{r setup}
library(tidyverse)
```

# Promblem 1
## data in pols-month.csv:
```{r}
pols_df=read.csv("./fivethirtyeight_datasets/pols-month.csv") %>% 
  janitor::clean_names() %>% 
  separate(
    col = mon, 
    into = c("year", "month", "day"), 
    sep = "-", 
  ) %>% 
    mutate(
      year  = as.character(year),
      month = as.integer(month),       
      month = month.name[month],       
      month = as.character(month),
      president = case_when(prez_gop == 1 ~ "gop",prez_dem == 1 ~ "dem")
  ) %>% 
  select(-day, -prez_gop, -prez_dem)
```

## data in snp.csv:
```{r}
snp_df=read.csv("./fivethirtyeight_datasets/snp.csv") %>% 
  janitor::clean_names() %>% 
    separate(
    col = date, 
    into = c("day", "month", "year"), 
    sep = "/", 
  ) %>% 
  mutate(
    month=month.name[as.integer(month)],
    year=as.integer(year),
    year  = ifelse(year < 50, 2000 + year, 1900 + year),
    year=as.character(year),
    month=as.character(month)) %>% 
  arrange(year,month) %>% 
  select(-day) %>% 
  select(year,month,everything())
```
## data in unemployment.csv:
```{r}
unemp_df=read.csv("./fivethirtyeight_datasets/unemployment.csv") %>% 
  janitor::clean_names() %>% 
  pivot_longer(
    jan:dec,
    names_to = 'month',
    values_to = "unemployment"
  ) %>% 
  mutate(
    month = month.name[match(tolower(month), tolower(month.abb))],
    year=as.character(year),
    month=as.character(month)
  )
```
## joining datasets:
```{r}

pols_snp = left_join(pols_df, snp_df, by = c("year", "month"))

final_df = left_join(pols_snp, unemp_df, by = c("year", "month"))
```

The `pols-month` dataset contains information on the number of national politicians (governors, senators, representatives) who were Republican or Democrat, and a variable indicating which party held the presidency in a given month.  

The `snp` dataset reports the closing value of the S&P stock index for each month.  

The `unemployment` dataset shows the percentage of unemployment, by month and year.  

After cleaning and merging by `year` and `month`, the resulting dataset has `r dim(final_df)[1]` rows and `r dim(final_df)[2]` columns, spanning years `r range(final_df$year, na.rm = TRUE)[1]` to `r range(final_df$year, na.rm = TRUE)[2]`. Key variables include `year`, `month`, `president` (party in power), `close` (S&P closing value), and `unemployment` (unemployment rate).  

# Problem 2
## Data in Mr. Trash Wheel sheet:
```{r}
mr_trash_df=readxl::read_excel("./fivethirtyeight_datasets/202409 Trash Wheel Collection Data.xlsx",
                            sheet = "Mr. Trash Wheel",
                            skip=1,
                            range="A2:N655"
                            ) %>% 
  janitor::clean_names() %>% 
  filter(!is.na(dumpster)) %>% 
  mutate(
    sports_balls=as.integer(round(sports_balls)),
    wheel="mr",
    year=as.character(year)
  ) %>% 
  select(wheel,everything())
```
## Data in Professor Trash Wheel:
```{r}
pro_trash_df=readxl::read_excel("./fivethirtyeight_datasets/202409 Trash Wheel Collection Data.xlsx",
                            sheet = "Professor Trash Wheel",
                            skip=1,
                            range="A2:M123"
                            ) %>% 
  janitor::clean_names() %>% 
  filter(!is.na(dumpster)) %>% 
  mutate(
    wheel="pro",
    year=as.character(year)
  ) %>% 
  select(wheel,everything())
```

## Data in Gwynnda Trash Wheel:
```{r}
gwy_trash_df=readxl::read_excel("./fivethirtyeight_datasets/202409 Trash Wheel Collection Data.xlsx",
                            sheet = "Gwynnda Trash Wheel",
                            skip=1,
                            range="A2:L266"
                            ) %>% 
  janitor::clean_names() %>% 
  filter(!is.na(dumpster)) %>% 
  mutate(
    wheel="gwy",
    year=as.character(year)
  ) %>% 
  select(wheel,everything())
```

## Combine:
```{r}
trash_df=bind_rows(mr_trash_df,pro_trash_df,gwy_trash_df)
```
The combined Trash Wheel dataset contains `r nrow(trash_df)` observations, each corresponding to a dumpster of trash collected by one of the wheels (Mr., Professor, or Gwynnda). Key variables include `dumpster` (the dumpster identifier), `date`, `weight_tons` (weight of trash in tons), `volume_cubic_yards`, and counts of items such as `plastic_bottles`, `polystyrene`, `cigarette_butts`, and `sports_balls`.  
For available data, Professor Trash Wheel has collected a total of `r trash_df %>% filter(wheel == "pro") %>% summarise(sum(weight_tons, na.rm = TRUE)) %>% pull()` tons of trash. Gwynnda collected `r format(trash_df %>% filter(wheel == "gwy", lubridate::year(date) == 2022, lubridate::month(date) == 6) %>% summarise(sum(cigarette_butts, na.rm = TRUE)) %>% pull(),scientific = FALSE)` cigarette butts in June 2022.

# Problem 3
## upload two files
```{r}
zip_code=read.csv("./zillow_data/Zip Codes.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    zip=as.character(zip_code)
  ) %>% 
  select(zip,county,neighborhood) %>% 
  arrange(zip)

zori_nyc=read.csv("./zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv") %>% 
  janitor::clean_names() %>% 
  pivot_longer(
    cols = 10:last_col(),
    names_to = "date",
    values_to = "rent_index"
  ) %>% 
  mutate(
    zip=as.character(region_name),
    date=str_remove(date,"^x"), 
    date=ymd(str_replace_all(date,"_","-"))
  ) %>% 
  select(zip,date,rent_index) %>% 
  arrange(zip)
```

## Merge the two files. 
Before we merge, we need to check for completeness and correctness across datasets.

```{r}
zipmap_dups <- zip_code %>% count(zip) %>% filter(n > 1)
zipmap_dups
zip_code <- zip_code %>%
  mutate(
    county = case_when(
      zip == "10463" ~ "Bronx", 
      zip == "11201" ~ "Kings", 
      TRUE ~ county 
    )
  ) %>%
  distinct(zip, .keep_all = TRUE) 

zori_final <- zori_nyc %>%
  left_join(zip_code, by = "zip") %>%
  arrange(zip, date)
```

```{r}
n_obs <- nrow(zori_final)

n_zip <- n_distinct(zori_final$zip)

n_neighborhood <- n_distinct(zori_final$neighborhood)

```

The resulting tidy dataset combines the Zillow ZORI monthly series with ZIP-level geographic information.  
Each row corresponds to one ZIP code in one month, containing variables such as `zip`, `date`, `rent_index`, `county`, and `neighborhood`.  
In total, the dataset includes `r n_obs` observations, covering `r n_zip` unique ZIP codes and `r n_neighborhood` unique neighborhoods.

```{r}
zip_missing <- anti_join(
  zip_code %>% distinct(zip),
  zori_nyc %>% distinct(zip),
  by = "zip"
)

nrow(zip_missing) 
head(zip_missing)
```
There are `r nrow(zip_missing)` ZIP codes present in the ZIP code dataset that do not appear in the Zillow Rental Price dataset.  
For example, ZIP codes `r paste(head(zip_missing, 3), collapse = ", ")` are in the geographic reference file but not in Zillowâ€™s rental index.  

Some ZIP codes are missing mainly because:  
(1) Some ZIP codes may correspond to non-residential areas (e.g., large office or industrial zones) where Zillow does not track rental listings.  
(2) Zillow often restricts its rental price index to areas with sufficient data quality and sample size, which means less populated or special-purpose ZIP codes may be left out.  

## Rental price comparison:
```{r}
rent_20_21 <- zori_final %>% 
  filter(
    month(date)==1,
    year(date) %in% c(2020,2021)
  ) %>% 
  mutate(year=year(date)) %>% 
  select(zip, year, rent_index, county, neighborhood)

rent_change <- rent_20_21 %>%
  pivot_wider(
    names_from = year,
    values_from = rent_index,
    names_prefix = "y"
  ) %>%
  mutate(change = y2021 - y2020) %>%
  filter(!is.na(y2020) & !is.na(y2021))

largest_drops <- rent_change %>%
  arrange(change) %>%
  head(n = 10) %>%
  select(zip, county, neighborhood, y2020, y2021, change)

largest_drops
```
Comparing January 2021 to January 2020, we calculated the year-over-year change in rent index for all ZIP codes.  
Table above shows the 10 ZIP codes with the largest decline. For example, ZIP codes such as `r largest_drops$zip[1]` and `r largest_drops$zip[2]` experienced the most dramatic drops.  

These declines are consistent with the impact of the COVID-19 pandemic: rental demand fell sharply in dense, high-cost neighborhoods, leading to reduced prices, while suburban areas sometimes saw more stable or even rising rents.

